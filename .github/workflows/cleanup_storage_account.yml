name: Cleanup Storage Account

on:
  workflow_call: 
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  cleanup-hsm:
    name: Cleanup Storage Account Blobs
    runs-on: ubuntu-latest
    steps:
      - name: Log into Azure
        run: |
          az login --service-principal \
            --username ${{ secrets.AZURE_SERVICE_PRINCIPAL_APP_ID }} \
            --password ${{ secrets.AZURE_SERVICE_PRINCIPAL_PASSWORD }} \
            --tenant ${{ secrets.AZURE_SERVICE_PRINCIPAL_TENANT }}

      - name: Get Connection String
        run: |
          CONNECTION_STRING=$(az storage account show-connection-string \
            --name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }})
          echo "CONNECTION_STRING=$CONNECTION_STRING"

      - name: Delete Blobs
        run: az storage blob list --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} --container-name ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }} --query "[].name" -o tsv --connection-string $CONNECTION_STRING | xargs -I{} az storage blob delete --container-name ${{ secrets.AZURE_STORAGE_CONTAINER_NAME }} --name {} --connection-string $CONNECTION_STRING
