name: Simple Server

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - .github/workflows/**
      - infra/**
      - examples/simple_server/**
  pull_request:
    branches:
      - main
    paths:
      - .github/workflows/**
      - infra/**
      - examples/simple_server/**
  merge_group:
    branches:
      - main

jobs:
  generate-id:
    name: Generate Unique ID
    runs-on: ubuntu-latest
    outputs:
      id: ${{ steps.generate-id.outputs.id }}
    steps:
      - name: Get Workflow ID
        id: generate-id
        run: echo "id=$(openssl rand -hex 8 | tr -d '\n')" >> $GITHUB_OUTPUT
  
  resolve-manifest:
    name: Resolve Manifest Variables
    uses: ./.github/workflows/_resolve_manifest.yml
    secrets: inherit
    with:
      manifest: examples/simple_server/manifest.json
      modifiers: ""
          
  build-and-push-images:
    name: Build and Push Images
    uses: ./.github/workflows/_push_example_images.yml
    secrets: inherit
    needs: [generate-id, resolve-manifest]
    with:
      id: ${{ needs.generate-id.outputs.id }}
      manifest: ${{ needs.resolve-manifest.outputs.manifest}}

  deploy-aci:
    name: Deploy Containers
    uses: ./.github/workflows/aci_deploy.yml
    secrets: inherit
    needs: [generate-id, resolve-manifest, build-and-push-images]
    strategy:
      matrix:
        location: ["westeurope"]
        security-policy: ["_generated.rego"]
    with:
      id: ${{ needs.generate-id.outputs.id }}
      manifest: ${{ needs.resolve-manifest.outputs.manifest}}
      location: ${{ matrix.location }}
      security-policy: ${{ matrix.security-policy }}

  remove-aci:
    name: Remove Containers
    uses: ./.github/workflows/aci_remove.yml
    needs: [generate-id, resolve-manifest, deploy-aci]
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        location: ["westeurope"]
        security-policy: ["_generated.rego"]
    with:
      id: ${{ needs.generate-id.outputs.id }}
      manifest: ${{ needs.resolve-manifest.outputs.manifest}}
      location: ${{ matrix.location }}
      security-policy: ${{ matrix.security-policy }}
